#!/bin/bash
# yadm bootstrap script for a new Mac

# Function to check if a command exists
command_exists() {
    command -v "$1" >/dev/null 2>&1
}

if [[ "$(uname)" != "Darwin" ]]; then
    echo "[BOOTSTRAP] This bootstrap is for macOS only."
    exit 1
fi

echo "[BOOTSTRAP] macOS detected."

# Check for Xcode CLI tools and install if not present
if ! xcode-select -p &> /dev/null; then
    echo "[BOOTSTRAP] Installing Xcode Command Line Tools"
    xcode-select --install
    until xcode-select -p &> /dev/null; do
        sleep 5
    done
else
    echo "[BOOTSTRAP] Xcode Command Line Tools already installed"
fi

# Install Homebrew if needed
if ! command_exists brew; then
    echo "[BOOTSTRAP] Installing Homebrew"
    bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
fi

if ! command_exists brew; then
    echo "[BOOTSTRAP] Homebrew installation failed."
    exit 1
fi

echo "[BOOTSTRAP] Installing/Updating packages"
brew update

brew install \
    bat \
    eza \
    fd \
    flyctl \
    fzf \
    gdu \
    gh \
    git \
    htop \
    jless \
    jq \
    lazygit \
    lf \
    lua \
    mise \
    mlx \
    mosh \
    nerdfetch \
    neovim \
    ollama \
    openssl \
    ripgrep \
    starship \
    temporal \
    tmux \
    tree \
    uv \
    yadm \
    yq

echo "[BOOTSTRAP] Installing fonts"
brew install --cask \
    font-fira-code-nerd-font \
    font-jetbrains-mono-nerd-font

echo "[BOOTSTRAP] Installing GUI apps"
brew install --cask \
    1password \
    1password-cli \
    bambu-studio \
    brave-browser \
    chatgpt \
    claude \
    cleanshot \
    cursor \
    discord \
    docker \
    docker-desktop \
    google-chrome \
    granola \
    handbrake \
    logi-options+ \
    microsoft-teams \
    monitorcontrol \
    notion \
    obsidian \
    postman \
    signal \
    slack \
    spotify \
    tailscale \
    tailscale-app \
    telegram \
    trezor-suite \
    visual-studio-code \
    vlc \
    webex \
    whatsapp \
    zed \
    zoom

# Set up python and node with mise
if command_exists mise; then
    echo "[BOOTSTRAP] Setting up python and node with mise"
    mise use --global python@3.11
    mise use --global python@3.12
    mise use --global node@latest
else
    echo "[BOOTSTRAP] ERROR - mise installation failed"
    exit 1
fi

# Install Python tools with uv
if command_exists uv; then
    echo "[BOOTSTRAP] Installing Python tools with uv"
    uv tool install tldr
else
    echo "[BOOTSTRAP] ERROR - uv is missing"
fi

# Clone tpm if not already present
if [ ! -d "$HOME/.tmux/plugins/tpm" ]; then
    echo "[BOOTSTRAP] Cloning tpm"
    git clone https://github.com/tmux-plugins/tpm ~/.tmux/plugins/tpm
fi

echo "[BOOTSTRAP] Setup is complete."
echo "[BOOTSTRAP] Remember to install tpm plugins in tmux <leader>I"
